<HTML>

<HEAD>
<TITLE>CS350 - Operating Systems</TITLE>
  <meta name="robots" content="noindex,nofollow">
</HEAD>

<BODY>

<CENTER>
<H1>Assignment:<BR>
Kernel Modules and Character Device</H1>
</CENTER>

<a name=parta>
<H2>Part A: Character Device</H2>
</a>

<OL>

<LI><P>
Implement a kernel module that
creates a <tt>/dev/mytime</tt> character device.
The character device should support the <tt>read()</tt> operation. When <tt>read()</tt> is
called, it should return a single string that contains the result both 
current_kernel_time() and getnstimeofday() functions in the kernel.
For example, the output should be as follows:

<pre>
current_kernel_time: 378959784 384958
getnstimeofday: 378959784 384990
</pre>
</LI>

<LI>
Also, provide a user-level application program that compares the resolution of time reported by your module with that reported by user-level gettimeofday() library routine.
<b>Understand and explain the reason for any difference in your journal.</b>

<p>
One such application could be written as follows (please fill in the missing code):
</LI>

<pre>
#define N ...

struct timeval gtodTimes[N];
char *procClockTimes[N];

...
/* allocate memory for character buffers HERE before you use them */

fd = open("/dev/mytime", O_RDONLY);
/* check for errors HERE */

for( i=0; i &lt; N; i++)
{
	gettimeofday(&ampgtodTimes[i], 0);
	bytes_read = read(fd, procClockTime[i], MAX_LENGTH);
	/* check for errors HERE */
}

close(fd);

for(i=0; i &lt; N; i++) {
	printf("...", gtodTimes[i], procClockTime[i]);
	/* fix the output format appropriately in the above line */
}

</pre>

</LI>


Run the user-level program for various values of <tt>N</tt> (both very small and very large).
In your journal, explain the reason for any differences that you observe between the three timing mechanisms.
<br>
<br>
<br>

<LI>Now, change the module so that <I>init_module()</I> returns -1,
recompile, and retest. What happens? Why?</LI>

</OL>

<a name=partB>
<H2>Part B: Experimenting With "Bad" Code</H2>
</a>

<OL>

<LI><P>Now, change implementation of 
your module so that <I>init_module()</I>
and/or <I>cleanup_module()</I> do something bad. Compile it.  If
it compiles OK, test it. But <EM><B>before testing it</B></EM>, use
"sync" to synchronize the file system in-memory structures with
those on disk, since it is likely that the system will crash, and
you will need to reboot.</P>

<P>The following are some typical errors. Try them one at a time.
Some of these may be caught
at compilation or link time, some may only cause problems when
you make the system call, or use <tt>insmod</tt> or <tt>rmmod</tt>
with the module.</P>

<UL>
<LI>division by zero</LI>
<LI>dereferencing a null pointer</LI>
<LI>returning no value or a value other than zero from <I>init_mod</I></LI>
<LI>calling a C library routine (<I>e.g.,</I> <I>malloc()</I> or <I>printf()</I>)
from inside a kernel module</LI>
<LI>whatever else that you think might cause a problem</LI>
</UL>

<P>Repeat a few such experiments, and see if you can hang or
crash the entire system. Keep a journal of what you try, and what
effects you observed. 

<p> IMPORTANT; Save copies of the "bad" code that you tested,
by giving them different names. When the system crashes, you may 
lose your code.

<P>BEWARE that some of the things you do may have no immediate
visible effect, but may have a delayed effect that is disastrous.
This is generally the case if you write garbage into random
locations of kernel memory.  The location you corrupt may not be
referenced for a while.  It will be referenced later, and then the
effect will occur.  Therefore, you cannot assume that the thing
you did most recently is necessarily the cause of a crash.</P>

<P><EM>Do not go overboard on this part of the assignment.</EM>
The objective is to expose you to the various ways a kernel
failure can manifest itself, in preparation for testing your own
code.  The objective is not to do the most damage possible to your
system.  In particular, it would better if you you do not trash
your hard drive, since reinstalling the entire system can take a
frustratingly long time.  </P>
</OL>

<H2>What to submit</H2>
Submit a copy of your code, your journal, and README file 
before the due date of the assignment and bring a copy 
of the journal for your demo.



<a name=gg>
<H2>Grading Guidelines</H2>
</a>

<pre>
	Part A: Kernel Module - 75
		Correct functionality - 40
		User-level test code - 25
		Error checks and coding style - 10 

	Part B: Experimenting With "Bad" Code - 25
		Demonstrate and explain your bad code.
										
	Total = 100
</pre>


<a name=hints>
<H2>Hints</H2>
</a>

<UL TYPE=DISC>
 <li> <a href=http://lxr.free-electrons.com/>Kernel Cross Reference</a></li>
 <LI><A HREF="http://lwn.net/Kernel/LDD3/">Linux Device Drivers</A></LI>
 <LI><a href=http://lwn.net/images/pdf/LDD3/ch07.pdf>Chapter 7 of O'Reilly's LDD book</a>, especially the section on knowing the current time.</LI>
 <LI>Man page for gettimeofday().</LI>

 <LI> Introductory material on Linux Kernel
    <UL>

	<LI>
	Chapters 1 and 2 of the following online book provide a good introduction
	to the kernel, though with a bias towards device-driver development.
	<BR>
	<a href=http://lwn.net/Kernel/LDD3/>
	http://lwn.net/Kernel/LDD3/
	</a>
	</LI>

	<LI>
	The following website may also be useful

	<a href=http://www.linux.org/>
	http://www.linux.org/
	</a>
	</LI>

	<LI>
	For more info, just google for "Linux Kernel" and you'll get lots more.
	</LI>
     </UL>

</UL>



<TABLE WIDTH="100%"><TR><TD BGCOLOR="cccc99">
Acknowledgment: Adapted by <a href=http://www.cs.binghamton.edu/~kartik>Kartik Gopalan</a> from original assignment material on kernel installation, configuration and modules by <A HREF="http://www.cs.fsu.edu/~baker">T. P. Baker</A>. 
</TD></TR></TABLE>

</BODY>
</HTML>

